<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>POST-TEST</title>
  <style>
    body {
      font-family: 'Leelawadee UI';
      text-align: center;
      padding: 60px;
      background-image: url('Picwater2.jpg'); 
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .container {
      background-color: #ffffff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      max-width: 90%;
      height: 90%;
      margin: auto;
    }

    h2 {
      color: #60B5FF;
      margin-bottom: 20px;
    }

    .question {
      padding-top: 30px;
      font-size: 30px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #484966;
    }

    .options-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 30px;
      justify-items: center;
    }

    .option-btn {
      width: 95%;       
      min-height: 120px;  
      padding: 10px;
      margin: 10px;     
      background-color: #afccd3;
      color: white;   
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 20px;   
      transition: background-color 0.2s ease;
    }

    .option-btn:hover {
      background-color: #6d7e83;
    }

    @media (max-width: 480px) {
      .options-container {
        grid-template-columns: 1fr;
      }
    }

    #ageQuestion {
      display: none;
      background-color: #ffffff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      max-width: 90%;
      margin: auto;
    }

    input[type="text"] {
      font-size: 20px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      width: 100px;
      text-align: center;
    }

    textarea {
      margin-top: 20px;
      font-size: 16px;
      width: 100%;
      height: 140px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      resize: none;
    }

    button {
      padding: 10px 20px;
      margin-top: 20px;
      background-color: #60B5FF;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      cursor: pointer;
    }

    button:hover {
      background-color: #3c95d9;
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

  <!-- คำถามแบบปรนัย -->
  <div class="container" id="quizContainer">
    <img src="TITLE2.png" alt="Welcome Image" style="width: 200%; max-width: 400px; border-radius: 15px;">
    <div id="question" class="question">คำถามจะปรากฏตรงนี้</div>
    <div id="options" class="options-container"></div>
  </div>

  <!-- คำถามเรทอายุ -->
  <div id="ageQuestion">
    <div class="question">กรุณาใส่ช่วงอายุของคุณ (1-6)</div>
    <input id="ageInput" type="text" maxlength="1" placeholder="1-6" />
    <textarea disabled>
กรุณาตอบตามความจริง
1 => ต่ำกว่า 12
2 => 12 - 24
3 => 25 - 35
4 => 36 - 50
5 => 51 - 60
6 => 60 ขึ้นไป
    </textarea>
    <br>
    <button onclick="submitAge()">ส่งข้อมูล</button>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDzY4p78Gk0HhCwNPBdPYC4I8arT6CUFgo",
      authDomain: "healer-wating.firebaseapp.com",
      projectId: "healer-wating",
      storageBucket: "healer-wating.appspot.com",
      messagingSenderId: "723339403882",
      appId: "1:723339403882:web:3f23f47a9cedce6e69e013",
      measurementId: "G-JNCLBF382P"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentQuestion = 0;
    let score = 0;
    let isSubmitted = false;

    const questions = [
      {
        question: "การบำบัดน้ำเสียมีความสำคัญอย่างไร?",
        options: [
          { text: "เพื่อเพิ่มจำนวนปลาน้ำจืด", value: "A" },
          { text: "เพื่อควบคุมระดับน้ำในแม่น้ำ", value: "B" },
          { text: "เพื่อลดมลพิษก่อนปล่อยลงแหล่งน้ำ", value: "C" },
          { text: "เพื่อผลิตไฟฟ้า", value: "D" }
        ],
        answer: "C"
      },
      {
        question: "กระบวนการใดต่อไปนี้ใช้ในการบำบัดน้ำเสีย?",
        options: [
          { text: "การระเหย", value: "A" },
          { text: "การตากแดด", value: "B" },
          { text: "การเติมอากาศ (Aeration)", value: "C" },
          { text: "การกรองด้วยทรายเพียงอย่างเดียว", value: "D" }
        ],
        answer: "C"
      },
      {
        question: "ข้อใดเป็นหน่วยงานที่มีหน้าที่ดูแลและควบคุมการบำบัดน้ำเสียในประเทศไทยเป็นหลัก?",
        options: [
          { text: "กระทรวงทรัพยากรธรรมชาติและสิ่งแวดล้อม", value: "A" },
          { text: "กรมควบคุมมลพิษ", value: "B" },
          { text: "กรมการเปลี่ยนแปลงสภาพภูมิอากาศและสิ่งแวดล้อม", value: "C" },
          { text: "กรมทรัพยากรน้ำบาดาล", value: "D" }
        ],
        answer: "B"
      },
      {
        question: "ข้อใดสอดคล้องน้อยที่สุดกับแนวทางการแก้ไขปัญหาน้ำเสียของแหล่งน้ำทั้ง 3 แห่งที่กล่าวมา?",
        options: [
          { text: "การวางระบบรวบรวมและบำบัดน้ำเสียจากชุมชนเป็นวิธีที่ใช้ในคลองแสนแสบและคลองเปรมประชากร", value: "A" },
          { text: "การบำบัดน้ำเสียโดยใช้พืชเป็นแนวทางหลักของโครงการที่คลองเปรมประชากร", value: "B" },
          { text: "บึงมักกะสันใช้ทั้งวิธีธรรมชาติและเครื่องกลในการฟื้นฟูคุณภาพน้ำ", value: "C" },
          { text: "โครงการบำบัดน้ำเสียมีนบุรีมีขีดความสามารถในการรองรับน้ำเสียมากกว่า 50,000 ลบ.ม./วัน", value: "D" }
        ],
        answer: "B"
      },
      {
        question: "จากสถานการณ์น้ำเสียในกรุงเทพมหานคร ข้อใดเป็นเหตุผลหลักที่โครงการมีนบุรีเน้นระบบบำบัดรายครัวเรือน?",
        options: [
          { text: "น้ำเสียมีปริมาณน้อยและกระจายตัว", value: "A" },
          { text: "น้ำเสียจากโรงงานต้องบำบัดเฉพาะจุด", value: "B" },
          { text: "น้ำเสียจากครัวเรือนถูกปล่อยลงคลองโดยตรง", value: "C" },
          { text: "มีแหล่งน้ำธรรมชาติที่เจือจางได้", value: "D" }
        ],
        answer: "C"
      }
    ];

    function showQuestion() {
      const q = questions[currentQuestion];
      document.getElementById('question').textContent = q.question;

      const optionsDiv = document.getElementById('options');
      optionsDiv.innerHTML = "";

      q.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = opt.text;
        btn.onclick = () => {
          if (opt.value.toUpperCase() === q.answer.toUpperCase()) {
            score++;
          }
          currentQuestion++;
          if (currentQuestion < questions.length) {
            showQuestion();
          } else {
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('ageQuestion').style.display = 'block';
          }
        };
        optionsDiv.appendChild(btn);
      });
    }

    function generateNewUserId(callback) {
      const col = db.collection("quizResults");
      col.orderBy("timestamp", "desc").limit(1).get()
        .then(snapshot => {
          if (snapshot.empty) {
            callback("user01");
          } else {
            let lastId = snapshot.docs[0].id;
            let num = parseInt(lastId.replace("user", ""), 10);
            num++;
            let newId = "user" + num.toString().padStart(2, "0");
            callback(newId);
          }
        })
        .catch(err => {
          console.error("Error getting last user id:", err);
          callback("user01");
        });
    }

    const ageInput = document.getElementById("ageInput");
    ageInput.addEventListener("input", () => {
      ageInput.value = ageInput.value.replace(/[^1-6]/g, "");
    });

    function submitAge() {
      const ageText = ageInput.value.trim();
      if (!ageText) {
        alert("กรุณาใส่เลข 1-6 ก่อนส่งข้อมูล");
        return;
      }

      generateNewUserId(userId => {
        const timestamp = firebase.firestore.FieldValue.serverTimestamp();

        db.collection("quizResults").doc(userId).set({
          score: score,
          total: questions.length,
          timestamp: timestamp
        });

        db.collection("ageResponses").doc(userId).set({
          age: ageText,
          timestamp: timestamp
        }).then(() => {
          isSubmitted = true;
          alert("ส่งข้อมูลเรียบร้อย ขอบคุณครับ!");
          window.location.href = `home.html?score=${score}`;
        }).catch(error => {
          console.error("บันทึกข้อมูลล้มเหลว: ", error);
          alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
        });
      });
    }

    // ป้องกันออกโดยไม่ได้ส่ง
    window.onbeforeunload = function () {
      if (!isSubmitted) {
        return "คุณยังไม่ได้ส่งแบบทดสอบ POST-TEST! แน่ใจหรือว่าจะออก?";
      }
    };

    showQuestion();
  </script>

</body>
</html>




